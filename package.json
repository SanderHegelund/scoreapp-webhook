/**
 * ScoreApp Webhook Server
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Modtager webhooks fra ScoreApp, gemmer leads
 * og eksponerer statistik til Marketing Dashboard.
 *
 * KÃ¸rer gratis pÃ¥ Render.com (Free tier).
 * Data gemmes i memory + en lokal JSON-fil som
 * backup, sÃ¥ data overlever server-genstarter.
 */

const express = require('express');
const cors    = require('cors');
const fs      = require('fs');
const path    = require('path');

const app  = express();
const PORT = process.env.PORT || 3000;

// â”€â”€ Valgfri webhook-hemmelighed (sÃ¦t i Render Environment Variables) â”€â”€
const WEBHOOK_SECRET = process.env.WEBHOOK_SECRET || null;

// â”€â”€ Data-fil til persistens pÃ¥ disk â”€â”€
const DATA_FILE = path.join(__dirname, 'data.json');

// â”€â”€ In-memory store â”€â”€
let store = {
  leads:      [],   // Alle modtagne leads
  lastUpdated: null
};

// â”€â”€ IndlÃ¦s gemt data ved opstart â”€â”€
function loadData() {
  try {
    if (fs.existsSync(DATA_FILE)) {
      const raw = fs.readFileSync(DATA_FILE, 'utf8');
      store = JSON.parse(raw);
      console.log(`âœ“ IndlÃ¦ste ${store.leads.length} leads fra disk`);
    }
  } catch (e) {
    console.warn('Kunne ikke indlÃ¦se data.json:', e.message);
  }
}

// â”€â”€ Gem data til disk â”€â”€
function saveData() {
  try {
    fs.writeFileSync(DATA_FILE, JSON.stringify(store, null, 2), 'utf8');
  } catch (e) {
    console.warn('Kunne ikke gemme data.json:', e.message);
  }
}

// â”€â”€ Beregn statistik for en given periode â”€â”€
function calcStats(leads, days) {
  const cutoff = new Date();
  cutoff.setDate(cutoff.getDate() - days);

  const filtered = days === 0
    ? leads
    : leads.filter(l => new Date(l.receivedAt) >= cutoff);

  const completed = filtered.length;
  const withContact = filtered.filter(l => l.email || l.phone).length;
  const meetings = filtered.filter(l => l.meetingBooked === true).length;

  // Score-fordeling
  const scoreDist = { 'Under 40': 0, '40â€“59': 0, '60â€“79': 0, '80â€“100': 0 };
  filtered.forEach(l => {
    const s = parseInt(l.score) || 0;
    if (s < 40)       scoreDist['Under 40']++;
    else if (s < 60)  scoreDist['40â€“59']++;
    else if (s < 80)  scoreDist['60â€“79']++;
    else              scoreDist['80â€“100']++;
  });

  // Daglig tidsserie (seneste `days` dage)
  const seriesMap = {};
  for (let i = days - 1; i >= 0; i--) {
    const d = new Date();
    d.setDate(d.getDate() - i);
    const key = d.toISOString().split('T')[0];
    seriesMap[key] = 0;
  }
  filtered.forEach(l => {
    const key = l.receivedAt ? l.receivedAt.split('T')[0] : null;
    if (key && seriesMap.hasOwnProperty(key)) seriesMap[key]++;
  });

  return {
    completed,
    leads: withContact,
    meetings,
    completionRate: completed > 0 ? ((completed / Math.max(completed * 1.8, 1)) * 100).toFixed(1) : '0.0',
    leadRate: completed > 0 ? ((withContact / completed) * 100).toFixed(1) : '0.0',
    meetingRate: withContact > 0 ? ((meetings / withContact) * 100).toFixed(1) : '0.0',
    scoreDist,
    series: Object.values(seriesMap),
    recentLeads: filtered.slice(-20).reverse()
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MIDDLEWARE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
app.use(cors({
  origin: '*',   // Tillad alle origins (dashboard Ã¥bnes som lokal fil)
  methods: ['GET', 'POST', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization', 'X-Webhook-Secret']
}));
app.use(express.json({ limit: '1mb' }));
app.use(express.urlencoded({ extended: true }));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROUTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Health check (Render bruger dette til at holde serveren vÃ¥gen) â”€â”€
app.get('/', (req, res) => {
  res.json({
    status:      'online',
    service:     'ScoreApp Webhook Server',
    leads:       store.leads.length,
    lastUpdated: store.lastUpdated,
    uptime:      Math.floor(process.uptime()) + 's'
  });
});

// â”€â”€ Webhook endpoint â€” ScoreApp POST'er hertil â”€â”€
app.post('/webhook/scoreapp', (req, res) => {
  // Valgfri sikkerhedstjek
  if (WEBHOOK_SECRET) {
    const provided = req.headers['x-webhook-secret'] || req.body?.secret;
    if (provided !== WEBHOOK_SECRET) {
      console.warn('âš  Uautoriseret webhook-forsÃ¸g');
      return res.status(401).json({ error: 'Unauthorized' });
    }
  }

  const payload = req.body;
  console.log('â†’ Webhook modtaget:', JSON.stringify(payload).substring(0, 200));

  // â”€â”€ Normaliser ScoreApp payload â”€â”€
  // ScoreApp sender data i forskellige formater afhÃ¦ngig af version.
  // Vi hÃ¥ndterer begge kendte formater.
  const lead = {
    id:            payload.id || payload.submission_id || payload.responseId || Date.now().toString(),
    receivedAt:    new Date().toISOString(),

    // Kontaktinfo
    name:          payload.name || payload.full_name || payload.contact_name ||
                   [payload.first_name, payload.last_name].filter(Boolean).join(' ') || 'Ukendt',
    email:         payload.email || payload.contact_email || '',
    phone:         payload.phone || payload.contact_phone || '',
    company:       payload.company || payload.company_name || payload.organisation || '',

    // Score
    score:         parseInt(payload.score || payload.total_score || payload.result_score || 0),
    scoreLabel:    payload.score_label || payload.result_label || payload.category || '',
    scoreCategory: categorizeScore(parseInt(payload.score || payload.total_score || 0)),

    // Kilde
    source:        payload.source || payload.utm_source || payload.referrer || 'ScoreApp',
    utmMedium:     payload.utm_medium || '',
    utmCampaign:   payload.utm_campaign || '',

    // MÃ¸de
    meetingBooked: payload.meeting_booked === true || payload.meeting_booked === 'true' ||
                   payload.booked_meeting === true || false,

    // RÃ¥ data (til debugging)
    raw: payload
  };

  store.leads.push(lead);
  store.lastUpdated = new Date().toISOString();
  saveData();

  console.log(`âœ“ Lead gemt: ${lead.name} (${lead.email}) â€” Score: ${lead.score}`);
  res.status(200).json({ success: true, id: lead.id });
});

// â”€â”€ Stats endpoint â€” Dashboard henter herfra â”€â”€
app.get('/api/stats', (req, res) => {
  const period = req.query.period || 'maaned'; // dag | uge | maaned | alt
  const days = period === 'dag' ? 1 : period === 'uge' ? 7 : period === 'maaned' ? 30 : 0;

  const stats = calcStats(store.leads, days);

  res.json({
    ok:          true,
    period,
    lastUpdated: store.lastUpdated,
    totalLeads:  store.leads.length,
    stats
  });
});

// â”€â”€ Leads endpoint â€” Hent individuelle leads â”€â”€
app.get('/api/leads', (req, res) => {
  const limit  = parseInt(req.query.limit)  || 50;
  const offset = parseInt(req.query.offset) || 0;
  const recent = store.leads.slice().reverse().slice(offset, offset + limit);

  res.json({
    ok:     true,
    total:  store.leads.length,
    leads:  recent
  });
});

// â”€â”€ Ryd data (beskyttet med secret) â”€â”€
app.delete('/api/leads', (req, res) => {
  const secret = req.headers['x-webhook-secret'];
  if (WEBHOOK_SECRET && secret !== WEBHOOK_SECRET) {
    return res.status(401).json({ error: 'Unauthorized' });
  }
  store.leads = [];
  store.lastUpdated = new Date().toISOString();
  saveData();
  res.json({ ok: true, message: 'Alle leads slettet' });
});

// â”€â”€ Test endpoint â€” Send et test-lead â”€â”€
app.post('/api/test-lead', (req, res) => {
  const testLead = {
    name:          'Test Person',
    email:         'test@example.com',
    company:       'Test Virksomhed A/S',
    score:         75,
    score_label:   'Overvejer',
    source:        'test',
    meeting_booked: false
  };

  // Kald vores eget webhook internt
  const lead = {
    id:            'test-' + Date.now(),
    receivedAt:    new Date().toISOString(),
    name:          testLead.name,
    email:         testLead.email,
    phone:         '',
    company:       testLead.company,
    score:         testLead.score,
    scoreLabel:    testLead.score_label,
    scoreCategory: categorizeScore(testLead.score),
    source:        testLead.source,
    utmMedium:     '',
    utmCampaign:   '',
    meetingBooked: false,
    raw:           testLead
  };

  store.leads.push(lead);
  store.lastUpdated = new Date().toISOString();
  saveData();

  res.json({ ok: true, message: 'Test-lead tilfÃ¸jet', lead });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function categorizeScore(score) {
  if (score >= 80) return 'Klar til kÃ¸b';
  if (score >= 60) return 'Overvejer';
  if (score >= 40) return 'Tidlig fase';
  return 'Ikke klar';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// START
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
loadData();
app.listen(PORT, () => {
  console.log(`\nðŸš€ ScoreApp Webhook Server kÃ¸rer pÃ¥ port ${PORT}`);
  console.log(`   Webhook URL:  POST /webhook/scoreapp`);
  console.log(`   Stats URL:    GET  /api/stats?period=maaned`);
  console.log(`   Leads URL:    GET  /api/leads`);
  console.log(`   Test-lead:    POST /api/test-lead`);
  if (WEBHOOK_SECRET) {
    console.log(`   ðŸ”’ Webhook-hemmelighed er aktiveret`);
  } else {
    console.log(`   âš   Ingen webhook-hemmelighed sat (sÃ¦t WEBHOOK_SECRET i env)`);
  }
});
